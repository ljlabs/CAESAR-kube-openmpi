---
# Source: CAESAR-kube-openmpi/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: caesar-openmpi-ssh-key
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
type: Opaque
data:
  id_rsa: "LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUJsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFZRUFuR2hrcUxvdGlaVnFZUTBRUWV6d0NmMm1tVFJKOWdhOVdGTGNRZzFyQ3FRb0lLNE80M3NqCkJWNFkvVGhDejRpVE5BZ0FWaUFtUjFXdFdaUWl4YTh0RVlabW1hWWVHNDZpcDk2eVNHQitPSXZZSjJJdWxoT3hXdmd0QWsKU3JuS2tveWFoRHl4VE5ZUkdHTkRuQWwxUkxJdWJ1WkNEaEp5S3E1VmVWS2dGdkwxMmgyOU9XWXJYOUpHNmY2WFFKcFlFego0cXJsTzRvV29tUG50YTJPeWxIR3ZPOTZBWEV0amJtYkYxeTVJZzArTWdhUFZUZGdURDZjcDJDQU9YbjdsWE9oQ000RnF3CitWNzJrUzdMdXV5Sk9mVEY5UG5OSFhOR1dwZ1EzNkhSemRUYUpldnlraWpBWGhoWGEvaWhlcE5HcXIvbmpYSS9va3k1amQKbzBMK0N3NHlleERKWDBkWWo5VExmaFNaT3RMWklmaDdSYXJxRDdJV0F5YXBPWFo1Z1FlK2kyazFUdWFJUXNzWHFPUUVxZAo2Ny9GUm1IOFNpTVZuODVyTHk4bDV4aTlidGxGOEJSSVlSZDBKejZKbFQ3NUxjSmw1ektqK0h3RGJPaVJMREx5b3lPREtUCm1hTWRBbk1HNFM2dVBmdVJ2YmhuWmJ0Nm1ZbFNIN1crUGNHMU5HMmJBQUFGbURUY1orRTAzR2ZoQUFBQUIzTnphQzF5YzIKRUFBQUdCQUp4b1pLaTZMWW1WYW1FTkVFSHM4QW45cHBrMFNmWUd2VmhTM0VJTmF3cWtLQ0N1RHVON0l3VmVHUDA0UXMrSQprelFJQUZZZ0prZFZyVm1VSXNXdkxSR0dacG1tSGh1T29xZmVza2hnZmppTDJDZGlMcFlUc1ZyNExRSkVxNXlwS01tb1E4CnNVeldFUmhqUTV3SmRVU3lMbTdtUWc0U2NpcXVWWGxTb0JieTlkb2R2VGxtSzEvU1J1bitsMENhV0JNK0txNVR1S0ZxSmoKNTdXdGpzcFJ4cnp2ZWdGeExZMjVteGRjdVNJTlBqSUdqMVUzWUV3K25LZGdnRGw1KzVWem9Rak9CYXNQbGU5cEV1eTdycwppVG4weGZUNXpSMXpSbHFZRU4raDBjM1UyaVhyOHBJb3dGNFlWMnY0b1hxVFJxcS81NDF5UDZKTXVZM2FOQy9nc09NbnNRCnlWOUhXSS9VeTM0VW1UclMyU0g0ZTBXcTZnK3lGZ01tcVRsMmVZRUh2b3RwTlU3bWlFTExGNmprQktuZXUveFVaaC9Fb2oKRlovT2F5OHZKZWNZdlc3WlJmQVVTR0VYZENjK2laVSsrUzNDWmVjeW8vaDhBMnpva1N3eThxTWpneWs1bWpIUUp6QnVFdQpyajM3a2IyNFoyVzdlcG1KVWgrMXZqM0J0VFJ0bXdBQUFBTUJBQUVBQUFHQWNJcjVheU5VSXZ5OWFBb1RXYXlZNkVkNCtpCkpTMmRIdHFzRXN0ZWFiMEROZ29HcytVVmRJVXROcm5jRSs2Y0EzVTZneVBjYXlaSC8wMVZFdldCbDlqMitySWdJVEJmY3oKZVNGWUhaWTVISTBid3ZMMTNJMWMvNzAxL2J6VjAwc3hDekdsWGxxZ2tha2ZiVExsTHI2N3RlaC9QdE1kejZBMVlnTU1WUQpabEw2cnJEWmVKVFl2d0U2ZjZMdXlOQ0djWW81QWVsQ0gvdVdlejBkbUp0bkR6VlAzb1IyTmR5TzMxOS9DRFVrby9KNVhxCnl3R21yQllkZUo2S2hWRU53M05JRzB5dUE4ZmdCZGJPYUNYZm40eDlicHJ4MElHRk1Nd2x1MTM1SVplUHNwaEVQK2JQK00KdnE0d0R0TFRLUVh1eWgyb3FKZEgxQmE0M21VdWMzbmV6QTNTWnBLcnRTaHpOc0E1aGVnM3FkOGJkWjFVWWxqejZBS01LSQo0blpXRWlmT01BenZvVTA1R3NpUTE4ZmcyRHBoSGFrOUFjNHVYMVBGQk5yWEgwMSt0NnJDSHNxS293MzJPVzhyMm9qS1dqCkp2OEl3TTdOVDRXRngvT3hoZXliSE00SUNaWjN1NkFESDB0NndaQWVWNmtnTDZ1cDdwRlF5OWxiRHozSk9jdGpBSkFBQUEKd0NxSk8wTFp1TU4yRTF6Q0ZUSUNHQkFYTzNDak93RCtqMGFEME5xSkFJTW84MTFCbFJnSWlXWVREb0ZQc3I3MWtNeXpJLwp6T2JsODFTU1FJLzFTZmpsM2tBRDZoNzFLaTZtcjFPQlFhSEp3eEREWE04L1AxNjVCYkhuK3A4dmFUdVNQVzhnUGpmNXQyCmRNV0UzazZoTndsMHYrRFoydytWUU1SdVdFWGpSZjJwQWpYY0tLbWI3TWpxdVRyem5KQnhkL2lxUHFBd2Rrb2hzZm9OVG4KRFBGemF5QU9XZFExM1F4N2NxaG9WRmxXMUkwR0o4MGExU0VFdW9RSGRqTzRuMnlnQUFBTUVBemViMXBFSlI3d2Z0RkxmawpWVVdqKzNiMlYvU0ZaZWU4bTNGa0NrTE1tdEhEeVVUK0lJQmZpbnBVTFRhbWViOStraU1tNmplZEJBZ1o0VzhVYlVLWExrCmJSeHNQbVVHNzZyODlaR2RXZENQcFQ0azcrbUhkR2JqZkRtNXRuOXJYOHNMZkw1VWM5dHYvc05semZXUGF2OXNINzQ5UXIKamNlSXUyY2x4K2ZDTjkyQ1ZpUVJrTW5MdmNOSUZCSFRXcDZCcGdKU1JwT252SUpFam9IdUxyOUJxaTA1bktlZEw0eVdPWgpMbzR5bjIxVDl2aTBtVXZRZDFWb2VmUVNVTU1vOVhBQUFBd1FEQ2RwTEdFTUxyaGdCemkzaU9ldDIzNk1PeUdwc0NzL3N5CjNRRnU5NXluZ0c5OG5ULzQvN0ZRUG81U291NUJSeTYxZGxlRlhIWUFiZHFCSFhPMTBoV040ZmN5M1VNbFI5ZS91WnBLQTEKTE1iTmR2eDZ5b3h1UGpsMFpPaDk4R0dXZmVqVmhyWjFTSTZFa2xVVUI5ek9RUG9vQi9OSHB6Mm0rbUtmOUlXYjB6N1I1aQo2SDZCYkxhd0QwQ0phTVFISEJ6RnBBTXR5TUtVRWlHc3A5UWJCVDIvdG1BcnlFV083Q3J6MnU5dXRQQnR3K1ZxRFRWZFVICncyZTgxb1BtUENuVjBBQUFBZmEzbHNaUzVxYjNKa1lXRnVRRXQ1YkdVdFNtOXlaR0ZoYmk1c2IyTmhiQUVDQXdRPQotLS0tLUVORCBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0K"

  id_rsa.pub: "c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDY2FHU291aTJKbFdwaERSQkI3UEFKL2FhWk5FbjJCcjFZVXR4Q0RXc0twQ2dncmc3amV5TUZYaGo5T0VMUGlKTTBDQUJXSUNaSFZhMVpsQ0xGcnkwUmhtYVpwaDRianFLbjNySklZSDQ0aTlnbllpNldFN0ZhK0MwQ1JLdWNxU2pKcUVQTEZNMWhFWVkwT2NDWFZFc2k1dTVrSU9FbklxcmxWNVVxQVc4dlhhSGIwNVppdGYwa2JwL3BkQW1sZ1RQaXF1VTdpaGFpWStlMXJZN0tVY2E4NzNvQmNTMk51WnNYWExraURUNHlCbzlWTjJCTVBweW5ZSUE1ZWZ1VmM2RUl6Z1dyRDVYdmFSTHN1NjdJazU5TVgwK2MwZGMwWmFtQkRmb2RITjFOb2w2L0tTS01CZUdGZHIrS0Y2azBhcXYrZU5jaitpVExtTjJqUXY0TERqSjdFTWxmUjFpUDFNdCtGSms2MHRraCtIdEZxdW9Qc2hZREpxazVkbm1CQjc2TGFUVk81b2hDeXhlbzVBU3AzcnY4VkdZZnhLSXhXZnptc3ZMeVhuR0wxdTJVWHdGRWhoRjNRblBvbVZQdmt0d21Ybk1xUDRmQU5zNkpFc012S2pJNE1wT1pveDBDY3diaExxNDkrNUc5dUdkbHUzcVppVklmdGI0OXdiVTBiWnM9IGt5bGUuam9yZGFhbkBLeWxlLUpvcmRhYW4ubG9jYWwK"

  authorized_keys: "c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDY2FHU291aTJKbFdwaERSQkI3UEFKL2FhWk5FbjJCcjFZVXR4Q0RXc0twQ2dncmc3amV5TUZYaGo5T0VMUGlKTTBDQUJXSUNaSFZhMVpsQ0xGcnkwUmhtYVpwaDRianFLbjNySklZSDQ0aTlnbllpNldFN0ZhK0MwQ1JLdWNxU2pKcUVQTEZNMWhFWVkwT2NDWFZFc2k1dTVrSU9FbklxcmxWNVVxQVc4dlhhSGIwNVppdGYwa2JwL3BkQW1sZ1RQaXF1VTdpaGFpWStlMXJZN0tVY2E4NzNvQmNTMk51WnNYWExraURUNHlCbzlWTjJCTVBweW5ZSUE1ZWZ1VmM2RUl6Z1dyRDVYdmFSTHN1NjdJazU5TVgwK2MwZGMwWmFtQkRmb2RITjFOb2w2L0tTS01CZUdGZHIrS0Y2azBhcXYrZU5jaitpVExtTjJqUXY0TERqSjdFTWxmUjFpUDFNdCtGSms2MHRraCtIdEZxdW9Qc2hZREpxazVkbm1CQjc2TGFUVk81b2hDeXhlbzVBU3AzcnY4VkdZZnhLSXhXZnptc3ZMeVhuR0wxdTJVWHdGRWhoRjNRblBvbVZQdmt0d21Ybk1xUDRmQU5zNkpFc012S2pJNE1wT1pveDBDY3diaExxNDkrNUc5dUdkbHUzcVppVklmdGI0OXdiVTBiWnM9IGt5bGUuam9yZGFhbkBLeWxlLUpvcmRhYW4ubG9jYWwK"
---
# Source: CAESAR-kube-openmpi/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: caesar-openmpi-assets
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
data:
  gen_hostfile.sh: |
    set -xev

    target=$1
    max_try=$2

    trap "rm -f ${target}_new" EXIT TERM INT KILL

    cluster_size=$(kubectl -n g-3538638-myuwcacza get statefulsets caesar-openmpi-worker -o jsonpath='{.status.replicas}')

    tried=0
    until [ "$(wc -l < ${target}_new)" -eq $cluster_size ]; do
      pod_names=$(kubectl -n g-3538638-myuwcacza get pod \
        --selector=app=CAESAR-kube-openmpi,chart=CAESAR-kube-openmpi-0.1,release=caesar-openmpi,role=worker \
        --field-selector=status.phase=Running \
        -o=jsonpath='{.items[*].metadata.name}')

      rm -f ${target}_new
      for p in ${pod_names}; do
        echo "${p}.caesar-openmpi" >> ${target}_new
      done

      tried=$(expr $tried + 1)
      if [ -n "$max_try" ] && [ $max_try -ge $tried ]; then
        break
      fi
    done

    sed -i "1icaesar-openmpi-master.caesar-openmpi" ${target}_new

    if [ -e ${target}_new ]; then
      mv ${target}_new ${target}
    fi


  hostfile_update_every: "15"
---
# Source: CAESAR-kube-openmpi/templates/loadBalancer.yaml
apiVersion: v1
kind: Service
metadata:
  name: caesar-openmpi-exposed
spec:
  selector:
    app: CAESAR-kube-openmpi
  ports:
    - port: 80
      targetPort: 8080
  type: LoadBalancer
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
# using https://kubernetes.io/docs/tutorials/stateless-application/guestbook/#creating-the-redis-master-service

apiVersion: v1
kind: Service
metadata:
  name: redis-master
  labels:
    app: redis
    role: master
    tier: backend
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: redis
    role: master
    tier: backend
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-slave
  labels:
    app: redis
    role: slave
    tier: backend
spec:
  ports:
  - port: 6379
  selector:
    app: redis
    role: slave
    tier: backend
---
# Source: CAESAR-kube-openmpi/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: caesar-openmpi
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
spec:
  selector:
    app: CAESAR-kube-openmpi
    release: caesar-openmpi
  ports:
  - name: api
    port: 8080
    targetPort: 8080
---
# Source: CAESAR-kube-openmpi/templates/mpi-master.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caesar-openmpi-master
  labels:
    app: CAESAR-kube-openmpi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: CAESAR-kube-openmpi
  template:
    metadata:
      labels:
        app: CAESAR-kube-openmpi
        chart: CAESAR-kube-openmpi-0.1
        release: caesar-openmpi
        heritage: Helm
        role: master
        
    spec:
      hostname: caesar-openmpi-master
      subdomain: caesar-openmpi
      securityContext:
          null
      volumes:
      - name: kube-openmpi-guillotine
        emptyDir: {}
      - name: kube-openmpi-hostfile-dir
        emptyDir: {}

      - name: kube-openmpi-hostfile-updater-params
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: hostfile_update_every
            path: update_every

      - name: kube-openmpi-utils
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: gen_hostfile.sh
            path: gen_hostfile.sh
            mode: 365
      - name: kube-openmpi-ssh-key
        secret:
          secretName: caesar-openmpi-ssh-key
          defaultMode: 256

      - name: nfs-neanias-mpi
        persistentVolumeClaim:
          claimName: nfs-neanias-mpi

      initContainers:
      - name: hostfile-initializer
        image: everpeace/kubectl:1.9.2
        imagePullPolicy: IfNotPresent
        command:
          - sh
          - -c
          - |
            /kube-openmpi/utils/gen_hostfile.sh $HOSTFILE_DIR/hostfile
        env:
        - name: HOSTFILE_DIR
          value: /kube-openmpi/generated
        volumeMounts:
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        resources:
          limits:
            cpu: "4"
            memory: 1Gi
          requests:
            cpu: "2"
            memory: 1Gi

      containers:
      - name: mpi-master
        image: "jordaan0/caesar-rest:version-0.0.9"
        ports:
        - containerPort: 2022
          containerPort: 8080
        env:
        - name: HOSTFILE
          value: /kube-openmpi/generated/hostfile
        - name: GUILLOTINE
          value: /kube-openmpi/guillotine
        volumeMounts:
        - name: kube-openmpi-guillotine
          mountPath: /kube-openmpi/guillotine
        - name: kube-openmpi-ssh-key
          mountPath: /ssh-key/openmpi
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated/
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        - mountPath: /workspace
          name: nfs-neanias-mpi


        resources:
          limits:
            cpu: "4"
            memory: 1Gi
          requests:
            cpu: "2"
            memory: 1Gi



      - name: hostfile-updater
        image: everpeace/kubectl:1.9.2
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          while [ ! -e $GUILLOTINE/execute ];
          do
            /kube-openmpi/utils/gen_hostfile.sh $HOSTFILE_DIR/hostfile 1
            if [ -e /kube-openmpi/hostfile-updater-params/update_every ]; then
              SLEEP=$(cat /kube-openmpi/hostfile-updater-params/update_every)
            fi
            sleep ${SLEEP:-15}
          done
          echo Done.
        env:
        - name: HOSTFILE_DIR
          value: /kube-openmpi/generated
        - name: GUILLOTINE
          value: /kube-openmpi/guillotine
        volumeMounts:
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated
        - name: kube-openmpi-guillotine
          mountPath: /kube-openmpi/guillotine
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils
        - name: kube-openmpi-hostfile-updater-params
          mountPath: /kube-openmpi/hostfile-updater-params
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: redis-master
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
      role: master
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
        role: master
        tier: backend
    spec:
      containers:
      - name: master
        image: k8s.gcr.io/redis:e2e  # or just image: redis
        resources: 
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: redis-slave
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
      role: slave
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
        role: slave
        tier: backend
    spec:
      containers:
      - name: slave
        image: gcr.io/google_samples/gb-redisslave:v3
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        env:
        - name: GET_HOSTS_FROM
          value: dns
          # Using `GET_HOSTS_FROM=dns` requires your cluster to
          # provide a dns service. As of Kubernetes 1.3, DNS is a built-in
          # service launched automatically. However, if the cluster you are using
          # does not have a built-in DNS service, you can instead
          # access an environment variable to find the master
          # service's host. To do so, comment out the 'value: dns' line above, and
          # uncomment the line below:
          # value: env
        ports:
        - containerPort: 6379
---
# Source: CAESAR-kube-openmpi/templates/horizonalPodAutoscaler.yaml
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: caesar-openmpi-master
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: caesar-openmpi-master
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 5
---
# Source: CAESAR-kube-openmpi/templates/mpi-cluster.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: caesar-openmpi-worker
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
    role: worker
spec:
  selector:
    matchLabels:
      app: CAESAR-kube-openmpi
      chart: CAESAR-kube-openmpi-0.1
      release: caesar-openmpi
      heritage: Helm
      role: worker
  serviceName: caesar-openmpi
  podManagementPolicy: Parallel
  replicas: 1
  template:
    metadata:
      labels:
        app: CAESAR-kube-openmpi
        chart: CAESAR-kube-openmpi-0.1
        release: caesar-openmpi
        heritage: Helm
        role: worker
    spec:
      securityContext:
        null
      volumes:
      - name: kube-openmpi-ssh-key
        secret:
          secretName: caesar-openmpi-ssh-key
          defaultMode: 256
      - name: kube-openmpi-utils
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: gen_hostfile.sh
            path: gen_hostfile.sh
            mode: 365

      - name: nfs-neanias-mpi
        persistentVolumeClaim:
          claimName: nfs-neanias-mpi

      initContainers:
      containers:
      - name: mpi-worker
        image: "jordaan0/caesar-rest:version-0.0.9"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 2022
          containerPort: 8080
        volumeMounts:
        - name: kube-openmpi-ssh-key
          mountPath: /ssh-key/openmpi
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        - mountPath: /workspace
          name: nfs-neanias-mpi

        resources:
          limits:
            cpu: "0.5"
          requests:
            cpu: "0.5"
