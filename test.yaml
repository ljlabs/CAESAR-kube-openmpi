---
# Source: CAESAR-kube-openmpi/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: caesar-openmpi-ssh-key
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
type: Opaque
data:
  id_rsa: "LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUJsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFZRUF2SDhrVjhaSDdTR2JHcXJXOWNMbk0vZ25IQkR0ZGV3TVpHcDA1UmVBU0JNdHlhRGpuMEtGCk9kcnRXMTdOVjNCZWtHNXlPT2tFRS9BV1BweW1MSVc5Ri90VEwyYkRvV0FyL3NablZINWxOeStJYzM1Qk5md2VCZHRLT1AKZU5TaFdiRDNwNkpuQ0R0WDJpVnd4ZGtRVUdVaDFPTzIzRmtlS200dS9zU05wVWkwdEsxMy9oWVd1TEpQcmkwd1BXVWI2dwo2YWpEdDNWS3hlZHd6MXRnV094dVhac2VqaVY1QjMxc215Y0hwZ0pJTWlYRmFkNGorTi9hRnJlamEvaXc5SmVpaXYwd2ZnClZDOUlDTEc3R2IvWkppR015amI4cGY4YlZhcUtMZUtaNGVBRmhNeTNNNGRRNjV5QVVqaXdHVEJ4cVo1MCtZYktNTS9oa0kKSmdFV3hVSnJwaEZKVjIxSlBPeFgyYTlXNlZWSUIyYVYwRmxRYVoyU2l5M2ZsODZjdlBad0JZc1B3YVRTSXRZblFQWHR3NQpkR3YyVU1yN21mdzNqaGdGbm1xS0FJS05takFDU0V4L3IxWHA1bXdkUnp6eEo2RHhzMzBQR1dRRGNVNG5weEc5WFlJaFFmCkUxWkhnbGdXbVMyNThGQ2U4dDEyMVd1R1JVdG00YTFKM0UvT3RBenhBQUFGbU43ZEhlRGUzUjNnQUFBQUIzTnphQzF5YzIKRUFBQUdCQUx4L0pGZkdSKzBobXhxcTF2WEM1elA0Snh3UTdYWHNER1JxZE9VWGdFZ1RMY21nNDU5Q2hUbmE3VnRlelZkdwpYcEJ1Y2pqcEJCUHdGajZjcGl5RnZSZjdVeTltdzZGZ0svN0daMVIrWlRjdmlITitRVFg4SGdYYlNqajNqVW9WbXc5NmVpClp3ZzdWOW9sY01YWkVGQmxJZFRqdHR4WkhpcHVMdjdFamFWSXRMU3RkLzRXRnJpeVQ2NHRNRDFsRytzT21vdzdkMVNzWG4KY005YllGanNibDJiSG80bGVRZDliSnNuQjZZQ1NESWx4V25lSS9qZjJoYTNvMnY0c1BTWG9vcjlNSDRGUXZTQWl4dXhtLwoyU1loak1vMi9LWC9HMVdxaWkzaW1lSGdCWVRNdHpPSFVPdWNnRkk0c0Jrd2NhbWVkUG1HeWpEUDRaQ0NZQkZzVkNhNllSClNWZHRTVHpzVjltdlZ1bFZTQWRtbGRCWlVHbWRrb3N0MzVmT25MejJjQVdMRDhHazBpTFdKMEQxN2NPWFJyOWxESys1bjgKTjQ0WUJaNXFpZ0NDalpvd0FraE1mNjlWNmVac0hVYzg4U2VnOGJOOUR4bGtBM0ZPSjZjUnZWMkNJVUh4TldSNEpZRnBrdAp1ZkJRbnZMZGR0VnJoa1ZMWnVHdFNkeFB6clFNOFFBQUFBTUJBQUVBQUFHQVpIOHc1QzlOMThyTUJCckRnc0lJUEhmNGVnCms0WVYrWmQ4d2VTS29QOWQxcjB3MFpicWFybXgzeTRIMFo0NTJBZldhMU5VeGVwVGFpMVh6MVI5V0I3SkJOV0g5a205eEgKZUkxVk9BSXZlbzI0SlVOU0J6TkUyb0NCQVFCUzd3VzM1emU0ZWxnUWtLbkw3TGNtQjVSek8wSnVuRmE1T0Q5c0ZLQXdETwpPQ29jVmh3S1ZvaDJVc0NXcE5sbzE4TFpjS2dYazk1OGo4TmFsZ1J0MkQ3OFVXVG9mT2NhRGU5elJTdkNIQi9TdElUSnhBCnRXSC9NY2cvWVU5RkxPS3BqYTV0eTNQMGFIdEF1VWM1d3N4WjE0WGhBaFlwbUtucUJPRXhBaU5raE5tSUxOcDBRSDlGOFkKT3dvS1VwaUE0aktzRWNmbStyOGg1TUdlVUtTMktyVFQxVER6d3hYbGFmOGNWd1RscTZDblVESjVXbXR6ek9OdFJ4a1EzVgpFNTA4YWlnMkpDZjErNFZZZHY2bmd0NEdaZ3VmK2JUWDcvZEZMY1Q0WFJ5U1oxaW5KSGoxZHA1ZFlxdEdjY0RMeU40YlZBClpUYjg1WTZPblJqWjJMUk1yK1dSWUYxRHJ5a29XN3NzRDdvRE5EL1ZrdnhycWU3SXp0L1RobU5jWlpoTDJYQXJ4VkFBQUEKd0Yrenc5VnRHN2NWQXlrdjNFRnByNWd3TmpPT0JXNU9rRmJaNHcrdEJlS0ZvTTZ4Nkt4aytPNkp2QmM0MVZZbC9PNy9EbwpDWGtvMGs5TjdIdndDZE5KcTVXRk9iN3BTa1VieHBJLzY2aytzZ2RFb1dVeWhlaTBiS2dNTEtKdVk1U3Y4MHVVSGZNRXNXCjltMmpGNC9XVGp6SmY0MnZmdTFJQ1dFMElRNHh0WUZOdE9od0sxTlFlWTdFZnVJdnNZODh4VU9OREdxd3ZNTWw2RW9jelMKL01PVnBZMUxxMGpCWEtxWDRmNkZLVEpSYkI1bVFzZWZhQTNDTkhuTEF2aG1ZWXJBQUFBTUVBNGFtam96a2M5cEpqQ3J1ZQpZU2VWUlJpVTBnV0o5SGIyY1pPRlVjM0FBTkhNV25hdlJ2ZU90Ri81RUl6SkNtT0V3c2xEOGoyTXdWUjlyVTRaRjNKNWNZCi9CUFVCeUp1ZFV2Z1VhcVhlYVBadS92dGNUNTNaU0IrYlJ2Yzl0V05rZW5SVnZ6UWplakFKWVZSejNHQnY2Y1pIUkdIWkIKTTk3aUJVVFhad3lMcmljNmc5MnIxWnAxZUxIUkxkVFM1N01QUFIxb25QenBKRENkaDdiQnozdW50RDkrZXJhVlB0bFdQdwpNYXcyNlZCOWgwSXI3dDhwTGxXUVhBSlJTVHczWi9BQUFBd1FEVjFtZXJOcU82VGtuOUNCand0bEcxM2plRnJOZnVxMlFCCjdKdE5HUzNhSEdsSVB4d2FSazZLNDBJRWFYQThsalRHYTVJQVhMeVY0VzJ1bUJ5ZXVOOVIvSXg4ckt4YXF0ZTRvMDhNVy8KcHZaZEI0dnByQ3pIcTZBdzM4eThuZXpVSDE5eU1DeHNoNzdFL3E1Q0NkUkkyaitSbDFITGhtWGJ4RUFFY0kwUFhoZDRaQgp0WGpvczNHUktSa3Vmd0lMOVFmMzVNcC9VYzA1N0s5RTJ4ZWk1RTNoV0EzUmVBemdQSGJxZnFScXJLMk5RQmhXN2w2ZUVLClJzQm5IdXpaaWxKSThBQUFBZmEzbHNaUzVxYjNKa1lXRnVRRXQ1YkdVdFNtOXlaR0ZoYmk1c2IyTmhiQUVDQXdRPQotLS0tLUVORCBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0K"

  id_rsa.pub: "c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDOGZ5Ulh4a2Z0SVpzYXF0YjF3dWN6K0NjY0VPMTE3QXhrYW5UbEY0QklFeTNKb09PZlFvVTUydTFiWHMxWGNGNlFibkk0NlFRVDhCWStuS1lzaGIwWCsxTXZac09oWUN2K3htZFVmbVUzTDRoemZrRTEvQjRGMjBvNDk0MUtGWnNQZW5vbWNJTzFmYUpYREYyUkJRWlNIVTQ3YmNXUjRxYmk3K3hJMmxTTFMwclhmK0ZoYTRzayt1TFRBOVpSdnJEcHFNTzNkVXJGNTNEUFcyQlk3RzVkbXg2T0pYa0hmV3liSndlbUFrZ3lKY1ZwM2lQNDM5b1d0Nk5yK0xEMGw2S0svVEIrQlVMMGdJc2JzWnY5a21JWXpLTnZ5bC94dFZxb290NHBuaDRBV0V6TGN6aDFEcm5JQlNPTEFaTUhHcG5uVDVoc293eitHUWdtQVJiRlFtdW1FVWxYYlVrODdGZlpyMWJwVlVnSFpwWFFXVkJwblpLTExkK1h6cHk4OW5BRml3L0JwTklpMWlkQTllM0RsMGEvWlF5dnVaL0RlT0dBV2Vhb29BZ28yYU1BSklUSCt2VmVubWJCMUhQUEVub1BHemZROFpaQU54VGllbkViMWRnaUZCOFRWa2VDV0JhWkxibndVSjd5M1hiVmE0WkZTMmJoclVuY1Q4NjBEUEU9IGt5bGUuam9yZGFhbkBLeWxlLUpvcmRhYW4ubG9jYWwK"

  authorized_keys: "c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDOGZ5Ulh4a2Z0SVpzYXF0YjF3dWN6K0NjY0VPMTE3QXhrYW5UbEY0QklFeTNKb09PZlFvVTUydTFiWHMxWGNGNlFibkk0NlFRVDhCWStuS1lzaGIwWCsxTXZac09oWUN2K3htZFVmbVUzTDRoemZrRTEvQjRGMjBvNDk0MUtGWnNQZW5vbWNJTzFmYUpYREYyUkJRWlNIVTQ3YmNXUjRxYmk3K3hJMmxTTFMwclhmK0ZoYTRzayt1TFRBOVpSdnJEcHFNTzNkVXJGNTNEUFcyQlk3RzVkbXg2T0pYa0hmV3liSndlbUFrZ3lKY1ZwM2lQNDM5b1d0Nk5yK0xEMGw2S0svVEIrQlVMMGdJc2JzWnY5a21JWXpLTnZ5bC94dFZxb290NHBuaDRBV0V6TGN6aDFEcm5JQlNPTEFaTUhHcG5uVDVoc293eitHUWdtQVJiRlFtdW1FVWxYYlVrODdGZlpyMWJwVlVnSFpwWFFXVkJwblpLTExkK1h6cHk4OW5BRml3L0JwTklpMWlkQTllM0RsMGEvWlF5dnVaL0RlT0dBV2Vhb29BZ28yYU1BSklUSCt2VmVubWJCMUhQUEVub1BHemZROFpaQU54VGllbkViMWRnaUZCOFRWa2VDV0JhWkxibndVSjd5M1hiVmE0WkZTMmJoclVuY1Q4NjBEUEU9IGt5bGUuam9yZGFhbkBLeWxlLUpvcmRhYW4ubG9jYWwK"
---
# Source: CAESAR-kube-openmpi/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: caesar-openmpi-assets
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
data:
  gen_hostfile.sh: |
    set -xev

    target=$1
    max_try=$2

    trap "rm -f ${target}_new" EXIT TERM INT KILL

    cluster_size=$(kubectl -n g-3538638-myuwcacza get statefulsets caesar-openmpi-worker -o jsonpath='{.status.replicas}')

    tried=0
    until [ "$(wc -l < ${target}_new)" -eq $cluster_size ]; do
      pod_names=$(kubectl -n g-3538638-myuwcacza get pod \
        --selector=app=CAESAR-kube-openmpi,chart=CAESAR-kube-openmpi-0.1,release=caesar-openmpi,role=worker \
        --field-selector=status.phase=Running \
        -o=jsonpath='{.items[*].metadata.name}')

      rm -f ${target}_new
      for p in ${pod_names}; do
        echo "${p}.caesar-openmpi" >> ${target}_new
      done

      tried=$(expr $tried + 1)
      if [ -n "$max_try" ] && [ $max_try -ge $tried ]; then
        break
      fi
    done

    sed -i "1icaesar-openmpi-master.caesar-openmpi" ${target}_new

    if [ -e ${target}_new ]; then
      mv ${target}_new ${target}
    fi


  hostfile_update_every: "15"
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
# using https://kubernetes.io/docs/tutorials/stateless-application/guestbook/#creating-the-redis-master-service

apiVersion: v1
kind: Service
metadata:
  name: redis-master
  labels:
    app: redis
    role: master
    tier: backend
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: redis
    role: master
    tier: backend
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-slave
  labels:
    app: redis
    role: slave
    tier: backend
spec:
  ports:
  - port: 6379
  selector:
    app: redis
    role: slave
    tier: backend
---
# Source: CAESAR-kube-openmpi/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: caesar-openmpi
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
spec:
  selector:
    app: CAESAR-kube-openmpi
    release: caesar-openmpi
  ports:
  - name: api
    port: 8080
    targetPort: 8080
---
# Source: CAESAR-kube-openmpi/templates/mpi-master.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caesar-openmpi-master
  labels:
    app: CAESAR-kube-openmpi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: CAESAR-kube-openmpi
  template:
    metadata:
      labels:
        app: CAESAR-kube-openmpi
        chart: CAESAR-kube-openmpi-0.1
        release: caesar-openmpi
        heritage: Helm
        role: master
        
    spec:
      restartPolicy: OnFailure
      hostname: caesar-openmpi-master
      subdomain: caesar-openmpi
      securityContext:
          null
      volumes:
      - name: kube-openmpi-guillotine
        emptyDir: {}
      - name: kube-openmpi-hostfile-dir
        emptyDir: {}

      - name: kube-openmpi-hostfile-updater-params
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: hostfile_update_every
            path: update_every

      - name: kube-openmpi-utils
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: gen_hostfile.sh
            path: gen_hostfile.sh
            mode: 365
      - name: kube-openmpi-ssh-key
        secret:
          secretName: caesar-openmpi-ssh-key
          defaultMode: 256
  
      - name: nfs-neanias-mpi
      persistentVolumeClaim:
        claimName: nfs-neanias-mpi
  
      initContainers:
      - name: hostfile-initializer
        image: everpeace/kubectl:1.9.2
        imagePullPolicy: IfNotPresent
        command:
          - sh
          - -c
          - |
            /kube-openmpi/utils/gen_hostfile.sh $HOSTFILE_DIR/hostfile
        env:
        - name: HOSTFILE_DIR
          value: /kube-openmpi/generated
        volumeMounts:
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils
      containers:
      - name: mpi-master
        image: "jordaan0/caesar-rest:version-0.0.9"
        ports:
        - containerPort: 2022
          containerPort: 8080
        env:
        - name: HOSTFILE
          value: /kube-openmpi/generated/hostfile
        - name: GUILLOTINE
          value: /kube-openmpi/guillotine
        volumeMounts:
        - name: kube-openmpi-guillotine
          mountPath: /kube-openmpi/guillotine
        - name: kube-openmpi-ssh-key
          mountPath: /ssh-key/openmpi
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated/
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

      - mountPath: /workspace
        name: nfs-neanias-mpi

        resources:
            limits:
              cpu: "0.5"
            requests:
              cpu: "0.5"


      - name: hostfile-updater
        image: everpeace/kubectl:1.9.2
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          while [ ! -e $GUILLOTINE/execute ];
          do
            /kube-openmpi/utils/gen_hostfile.sh $HOSTFILE_DIR/hostfile 1
            if [ -e /kube-openmpi/hostfile-updater-params/update_every ]; then
              SLEEP=$(cat /kube-openmpi/hostfile-updater-params/update_every)
            fi
            sleep ${SLEEP:-15}
          done
          echo Done.
        env:
        - name: HOSTFILE_DIR
          value: /kube-openmpi/generated
        - name: GUILLOTINE
          value: /kube-openmpi/guillotine
        volumeMounts:
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated
        - name: kube-openmpi-guillotine
          mountPath: /kube-openmpi/guillotine
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils
        - name: kube-openmpi-hostfile-updater-params
          mountPath: /kube-openmpi/hostfile-updater-params
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: redis-master
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
      role: master
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
        role: master
        tier: backend
    spec:
      containers:
      - name: master
        image: k8s.gcr.io/redis:e2e  # or just image: redis
        resources: 
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: redis-slave
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
      role: slave
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
        role: slave
        tier: backend
    spec:
      containers:
      - name: slave
        image: gcr.io/google_samples/gb-redisslave:v3
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        env:
        - name: GET_HOSTS_FROM
          value: dns
          # Using `GET_HOSTS_FROM=dns` requires your cluster to
          # provide a dns service. As of Kubernetes 1.3, DNS is a built-in
          # service launched automatically. However, if the cluster you are using
          # does not have a built-in DNS service, you can instead
          # access an environment variable to find the master
          # service's host. To do so, comment out the 'value: dns' line above, and
          # uncomment the line below:
          # value: env
        ports:
        - containerPort: 6379
---
# Source: CAESAR-kube-openmpi/templates/horizonalPodAutoscaler.yaml
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: caesar-openmpi-master
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Pod
    name: caesar-openmpi-master
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 1
---
# Source: CAESAR-kube-openmpi/templates/mpi-cluster.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: caesar-openmpi-worker
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
    role: worker
spec:
  selector:
    matchLabels:
      app: CAESAR-kube-openmpi
      chart: CAESAR-kube-openmpi-0.1
      release: caesar-openmpi
      heritage: Helm
      role: worker
  serviceName: caesar-openmpi
  podManagementPolicy: Parallel
  replicas: 1
  template:
    metadata:
      labels:
        app: CAESAR-kube-openmpi
        chart: CAESAR-kube-openmpi-0.1
        release: caesar-openmpi
        heritage: Helm
        role: worker
    spec:
      securityContext:
        null
      volumes:
      - name: kube-openmpi-ssh-key
        secret:
          secretName: caesar-openmpi-ssh-key
          defaultMode: 256
      - name: kube-openmpi-utils
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: gen_hostfile.sh
            path: gen_hostfile.sh
            mode: 365

      - name: nfs-neanias-mpi
        persistentVolumeClaim:
          claimName: nfs-neanias-mpi

      initContainers:
      containers:
      - name: mpi-worker
        image: "jordaan0/caesar-rest:version-0.0.9"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 2022
          containerPort: 8080
        volumeMounts:
        - name: kube-openmpi-ssh-key
          mountPath: /ssh-key/openmpi
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        - mountPath: /workspace
          name: nfs-neanias-mpi

        resources:
          limits:
            cpu: "0.5"
          requests:
            cpu: "0.5"
