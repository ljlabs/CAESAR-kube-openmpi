---
# Source: CAESAR-kube-openmpi/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: caesar-openmpi-ssh-key
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
type: Opaque
data:
  id_rsa: "LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUJsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFZRUE5a0h1Um02MmM3SXJRYjNobWxUMDBEMGdlQWNpRVZObFl2aExHNUswR3BNbXR0Ui9YK2prCnZnVDYxdW9ZTFIxMHFvWnZISlprcjQrdzBvaHAyVi9qM2w3MzVjUU5GazZyMGxQU25HMEVkK3RJbE8yajdMbnl3djVJaFcKdlR3a1lXSlhLOXVLT1dZWHdSRjdWZHNVcnVDWFErZXZLVEo5UTBNc3JEbHZuY09QRWtMM2trdU0xeHNZS0xQNmRVSGhZUgpOSU5KTExDaTVwMkxLQUUvOUNrVjA0QnV3enoxaXkrWngwM3Q2WTUzRVpIZnJ0YXFVUEQrVnpFZS9SYld0enJPcWxlSy9DCmpwOC8wMUpLcDJFei9GNWFXVlFOOERvRWhGa3B2YzkvYXpEZERrN1VJZmFOWThzL1lpaTdWSE5HczltWXdlZURwL2xsNkIKVVpVSUFjQ0RlNEJ2NzVmaGRtQ1AweU04M0pDV0dtaDBJa1hyd0RHcFlXR0hjeW1ZVVBIOHRGVmVSSGdjZ2xpc3E4ZUVIZwphTzNUVzV6UVFjSlRqVWRadThUWW9PZ3V4VCtPTFNCMlViOHRrV0pUblZDOTJBYnZaVXNESjhRdDVQUFNCRW5hY2pQUjc2Cjc1dThoaDZROVJVTkZmVkh2MXVGTXlablFhNlpGOFNYTmNlREtyakxBQUFGbUFaZVlkMEdYbUhkQUFBQUIzTnphQzF5YzIKRUFBQUdCQVBaQjdrWnV0bk95SzBHOTRacFU5TkE5SUhnSEloRlRaV0w0U3h1U3RCcVRKcmJVZjEvbzVMNEUrdGJxR0MwZApkS3FHYnh5V1pLK1BzTktJYWRsZjQ5NWU5K1hFRFJaT3E5SlQwcHh0QkhmclNKVHRvK3k1OHNMK1NJVnIwOEpHRmlWeXZiCmlqbG1GOEVSZTFYYkZLN2dsMFBucnlreWZVTkRMS3c1YjUzRGp4SkM5NUpMak5jYkdDaXorblZCNFdFVFNEU1N5d291YWQKaXlnQlAvUXBGZE9BYnNNODlZc3ZtY2RON2VtT2R4R1IzNjdXcWxEdy9sY3hIdjBXMXJjNnpxcFhpdndvNmZQOU5TU3FkaApNL3hlV2xsVURmQTZCSVJaS2IzUGYyc3czUTVPMUNIMmpXUExQMklvdTFSelJyUFptTUhuZzZmNVplZ1ZHVkNBSEFnM3VBCmIrK1g0WFpnajlNalBOeVFsaHBvZENKRjY4QXhxV0ZoaDNNcG1GRHgvTFJWWGtSNEhJSllyS3ZIaEI0R2p0MDF1YzBFSEMKVTQxSFdidkUyS0RvTHNVL2ppMGdkbEcvTFpGaVU1MVF2ZGdHNzJWTEF5ZkVMZVR6MGdSSjJuSXowZSt1K2J2SVlla1BVVgpEUlgxUjc5YmhUTW1aMEd1bVJmRWx6WEhneXE0eXdBQUFBTUJBQUVBQUFHQWRxVG5QdW5pWDdXTW43enpMOThVb0N1RE5ECkVEbWVOYktxYkQwUUlLWWU5WnJLYU93OCs2UFU2NjU4YWJaVWtXeDMzRGxMdGt3U3p5blV4NTZ2QUhJa0VSSUpNblZ3TUsKUjJoNVJVSkU3OTNjOTF2VEtaK2hOWTg3czRSeTN0dlRtYkZCZE83ajZnM1RVbC9nUnlYNXIzWmhEKzFGTnVCSFVkMWRCSwpWWEU5d2llZmpjMTJpc0NVRURBK1VEWXdkd3ZLTXdJeWJySlQ3c0o1Y0trQUVuY2VJaiswNm9ZcW5KWmp2R2owdERWS1M2Clowc25mWjNPZklXL0QyTHNpaFQ3UVNSamI1elp3S2JtWXBUZXVjSGMrVkR1TzZjY3h4Um4vL1hOTXhSRVEwakFpVVRaTTkKMXVXYTFRdW9oTGh4R1VIaGJRTTZLTTE1RlhCdXJHZDMvSjJiSUNleW1adDFBS0FZUDF2TGtwNS9wNmJlYmZxc1hWemdyeAoyTlBBNFUySTZFQW9Kcyt0Ykl0MlJvd3Zmbm5tanZtSFJYVklLU29JcXUwamUydHNpWEFZekYzcHJqcHE2RE1FRWw1Ry9GCmJvVlJ2bVkrYlhyUkhmNjY3SzIxWDFFTm1LTEJLMVN6T0FOamRlcmxxdU9vNmdIcmw4ZVJtSkxDMUpseVZpa0ZjQkFBQUEKd0d0L1JRZFVLSnJGemt2elhIWXZsWW1DTDkrUlJqQVhweHBMWHRhdS9IL3c2U1htU2VPaERmN2JicVZqakt6L1Rld1V4cwpubE16OSs2SzhFQk1QVFpqenkyY3hNRVJ1WVRoNVp2ZFY3UU10eFA0QjYxdHFCbDZ5Q3lGZFp5TmVCY3hQTWhQREcvaG0wCldkNDErNlFyQWRlR1RnU1NLK01iMHA1bVhCZUdjR05MRDhGTGhTVktwNmZEZ214MTFIRVdLTVlaVVdkNTZGUklEVFhna3YKS2VWUGE0Zm0zdXlRemZiNkNES0lsK1VBTElqaWtwT3pRNjgxQUpUVlhJZWtLZmxBQUFBTUVBL2MxWUJaTDczeTVzaGNOLwpXeDhBdms4N2ZmdVNxOVRLRDArdmtsSWxhV2NuUlJzVVYwODgveTBRdERGbXhleWp4aW5ZYVdQc24rTkV0ckZ5SGlQWUJLCnY1cStkTC9JeEE1cDBSdmpEQ1dUd3pwM0o5YWRuejh0aDQ1RjIwd1daQWw3YXFqalhSdXlYcEVDek4rRDhDUWYwM2c3MzYKMWJXVEVDdUR2SmJPRGZtR3RHZ0QrUzZ1OWZTdVc5TEQxYWE3N2tOZGhiSnJnTVF2d3ljN2V4MFZwUGVLNjFsdHJaeU5OaQpldERwZllUZVZJaU1VZGJaMDdxY3hETnU5VlZKYUJBQUFBd1FENFk5eDhtRjRSanpQMFVwbE1KenZ3RlpEWkpqcVRPdnpOCmx3QjNHbHJvYzl4V0RRLzUxdlIrRFozcFQ3SDJxNWJCYngwbXJVRGpSK3NjMXl0bWpwdTFBREdBZE1oYUwrSElMWG41L08KUmo4SVR3SGdSZFdnZnJtUzhXY1BCM3V1K2ZJd2hFWjNqV0J6WUtIOThvc2U4VE90dXdrY1VPeTY3Rys4SkpidURIZXIvZQpycGlzWklSTThLRXRpYWpxN1VoQW5UVml6bU9hYXlqSGtNeUpmZm8rTForZ3lXK0xkRUs2Z3c5WDUxdkRrY3d2VXluSU50CjV1NWhBNlhQWDhJVXNBQUFBZmEzbHNaUzVxYjNKa1lXRnVRRXQ1YkdVdFNtOXlaR0ZoYmk1c2IyTmhiQUVDQXdRPQotLS0tLUVORCBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0K"

  id_rsa.pub: "c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEMlFlNUdiclp6c2l0QnZlR2FWUFRRUFNCNEJ5SVJVMlZpK0VzYmtyUWFreWEyMUg5ZjZPUytCUHJXNmhndEhYU3FobThjbG1Tdmo3RFNpR25aWCtQZVh2Zmx4QTBXVHF2U1U5S2NiUVIzNjBpVTdhUHN1ZkxDL2tpRmE5UENSaFlsY3IyNG81WmhmQkVYdFYyeFN1NEpkRDU2OHBNbjFEUXl5c09XK2R3NDhTUXZlU1M0elhHeGdvcy9wMVFlRmhFMGcwa3NzS0xtbllzb0FULzBLUlhUZ0c3RFBQV0xMNW5IVGUzcGpuY1JrZCt1MXFwUThQNVhNUjc5RnRhM09zNnFWNHI4S09uei9UVWtxbllUUDhYbHBaVkEzd09nU0VXU205ejM5ck1OME9UdFFoOW8xanl6OWlLTHRVYzBhejJaakI1NE9uK1dYb0ZSbFFnQndJTjdnRy92bCtGMllJL1RJenpja0pZYWFIUWlSZXZBTWFsaFlZZHpLWmhROGZ5MFZWNUVlQnlDV0t5cng0UWVCbzdkTmJuTkJCd2xPTlIxbTd4TmlnNkM3RlA0NHRJSFpSdnkyUllsT2RVTDNZQnU5bFN3TW54QzNrODlJRVNkcHlNOUh2cnZtN3lHSHBEMUZRMFY5VWUvVzRVekptZEJycGtYeEpjMXg0TXF1TXM9IGt5bGUuam9yZGFhbkBLeWxlLUpvcmRhYW4ubG9jYWwK"

  authorized_keys: "c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FEMlFlNUdiclp6c2l0QnZlR2FWUFRRUFNCNEJ5SVJVMlZpK0VzYmtyUWFreWEyMUg5ZjZPUytCUHJXNmhndEhYU3FobThjbG1Tdmo3RFNpR25aWCtQZVh2Zmx4QTBXVHF2U1U5S2NiUVIzNjBpVTdhUHN1ZkxDL2tpRmE5UENSaFlsY3IyNG81WmhmQkVYdFYyeFN1NEpkRDU2OHBNbjFEUXl5c09XK2R3NDhTUXZlU1M0elhHeGdvcy9wMVFlRmhFMGcwa3NzS0xtbllzb0FULzBLUlhUZ0c3RFBQV0xMNW5IVGUzcGpuY1JrZCt1MXFwUThQNVhNUjc5RnRhM09zNnFWNHI4S09uei9UVWtxbllUUDhYbHBaVkEzd09nU0VXU205ejM5ck1OME9UdFFoOW8xanl6OWlLTHRVYzBhejJaakI1NE9uK1dYb0ZSbFFnQndJTjdnRy92bCtGMllJL1RJenpja0pZYWFIUWlSZXZBTWFsaFlZZHpLWmhROGZ5MFZWNUVlQnlDV0t5cng0UWVCbzdkTmJuTkJCd2xPTlIxbTd4TmlnNkM3RlA0NHRJSFpSdnkyUllsT2RVTDNZQnU5bFN3TW54QzNrODlJRVNkcHlNOUh2cnZtN3lHSHBEMUZRMFY5VWUvVzRVekptZEJycGtYeEpjMXg0TXF1TXM9IGt5bGUuam9yZGFhbkBLeWxlLUpvcmRhYW4ubG9jYWwK"
---
# Source: CAESAR-kube-openmpi/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: caesar-openmpi-assets
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
data:
  gen_hostfile.sh: |
    set -xev

    target=$1
    max_try=$2

    trap "rm -f ${target}_new" EXIT TERM INT KILL

    cluster_size=$(kubectl -n g-3538638-myuwcacza get statefulsets caesar-openmpi-worker -o jsonpath='{.status.replicas}')

    tried=0
    until [ "$(wc -l < ${target}_new)" -eq $cluster_size ]; do
      pod_names=$(kubectl -n g-3538638-myuwcacza get pod \
        --selector=app=CAESAR-kube-openmpi,chart=CAESAR-kube-openmpi-0.1,release=caesar-openmpi,role=worker \
        --field-selector=status.phase=Running \
        -o=jsonpath='{.items[*].metadata.name}')

      rm -f ${target}_new
      for p in ${pod_names}; do
        echo "${p}.caesar-openmpi" >> ${target}_new
      done

      tried=$(expr $tried + 1)
      if [ -n "$max_try" ] && [ $max_try -ge $tried ]; then
        break
      fi
    done

    sed -i "1icaesar-openmpi-master.caesar-openmpi" ${target}_new

    if [ -e ${target}_new ]; then
      mv ${target}_new ${target}
    fi


  hostfile_update_every: "15"
---
# Source: CAESAR-kube-openmpi/templates/loadBalancer.yaml
apiVersion: v1
kind: Service
metadata:
  name: caesar-openmpi-exposed
spec:
  selector:
    app: CAESAR-kube-openmpi
  ports:
    - port: 80
      targetPort: 8080
  type: LoadBalancer
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
# using https://kubernetes.io/docs/tutorials/stateless-application/guestbook/#creating-the-redis-master-service

apiVersion: v1
kind: Service
metadata:
  name: redis-master
  labels:
    app: redis
    role: master
    tier: backend
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: redis
    role: master
    tier: backend
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-slave
  labels:
    app: redis
    role: slave
    tier: backend
spec:
  ports:
  - port: 6379
  selector:
    app: redis
    role: slave
    tier: backend
---
# Source: CAESAR-kube-openmpi/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: caesar-openmpi
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
spec:
  selector:
    app: CAESAR-kube-openmpi
    release: caesar-openmpi
  ports:
  - name: api
    port: 8080
    targetPort: 8080
---
# Source: CAESAR-kube-openmpi/templates/mpi-master.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caesar-openmpi-master
  labels:
    app: CAESAR-kube-openmpi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: CAESAR-kube-openmpi
  template:
    metadata:
      labels:
        app: CAESAR-kube-openmpi
        chart: CAESAR-kube-openmpi-0.1
        release: caesar-openmpi
        heritage: Helm
        role: master
        
    spec:
      hostname: caesar-openmpi-master
      subdomain: caesar-openmpi
      securityContext:
          null
      volumes:
      - name: kube-openmpi-guillotine
        emptyDir: {}
      - name: kube-openmpi-hostfile-dir
        emptyDir: {}

      - name: kube-openmpi-hostfile-updater-params
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: hostfile_update_every
            path: update_every

      - name: kube-openmpi-utils
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: gen_hostfile.sh
            path: gen_hostfile.sh
            mode: 365
      - name: kube-openmpi-ssh-key
        secret:
          secretName: caesar-openmpi-ssh-key
          defaultMode: 256

      - name: nfs-neanias-mpi
        persistentVolumeClaim:
          claimName: nfs-neanias-mpi

      initContainers:
      - name: hostfile-initializer
        image: everpeace/kubectl:1.9.2
        imagePullPolicy: IfNotPresent
        command:
          - sh
          - -c
          - |
            /kube-openmpi/utils/gen_hostfile.sh $HOSTFILE_DIR/hostfile
        env:
        - name: HOSTFILE_DIR
          value: /kube-openmpi/generated
        volumeMounts:
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        resources:
          limits:
            cpu: "4"
            memory: 1Gi
          requests:
            cpu: "2"
            memory: 1Gi

      containers:
      - name: mpi-master
        image: "jordaan0/caesar-rest:version-0.0.9"
        ports:
        - containerPort: 2022
          containerPort: 8080
        env:
        - name: HOSTFILE
          value: /kube-openmpi/generated/hostfile
        - name: GUILLOTINE
          value: /kube-openmpi/guillotine
        volumeMounts:
        - name: kube-openmpi-guillotine
          mountPath: /kube-openmpi/guillotine
        - name: kube-openmpi-ssh-key
          mountPath: /ssh-key/openmpi
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated/
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        - mountPath: /workspace
          name: nfs-neanias-mpi


        resources:
          limits:
            cpu: "4"
            memory: 1Gi
          requests:
            cpu: "2"
            memory: 1Gi



      - name: hostfile-updater
        image: everpeace/kubectl:1.9.2
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          while [ ! -e $GUILLOTINE/execute ];
          do
            /kube-openmpi/utils/gen_hostfile.sh $HOSTFILE_DIR/hostfile 1
            if [ -e /kube-openmpi/hostfile-updater-params/update_every ]; then
              SLEEP=$(cat /kube-openmpi/hostfile-updater-params/update_every)
            fi
            sleep ${SLEEP:-15}
          done
          echo Done.
        env:
        - name: HOSTFILE_DIR
          value: /kube-openmpi/generated
        - name: GUILLOTINE
          value: /kube-openmpi/guillotine
        volumeMounts:
        - name: kube-openmpi-hostfile-dir
          mountPath: /kube-openmpi/generated
        - name: kube-openmpi-guillotine
          mountPath: /kube-openmpi/guillotine
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils
        - name: kube-openmpi-hostfile-updater-params
          mountPath: /kube-openmpi/hostfile-updater-params
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: redis-master
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
      role: master
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
        role: master
        tier: backend
    spec:
      containers:
      - name: master
        image: k8s.gcr.io/redis:e2e  # or just image: redis
        resources: 
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
---
# Source: CAESAR-kube-openmpi/templates/redis-cluster.yaml
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: redis-slave
  labels:
    app: redis
spec:
  selector:
    matchLabels:
      app: redis
      role: slave
      tier: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
        role: slave
        tier: backend
    spec:
      containers:
      - name: slave
        image: gcr.io/google_samples/gb-redisslave:v3
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        env:
        - name: GET_HOSTS_FROM
          value: dns
          # Using `GET_HOSTS_FROM=dns` requires your cluster to
          # provide a dns service. As of Kubernetes 1.3, DNS is a built-in
          # service launched automatically. However, if the cluster you are using
          # does not have a built-in DNS service, you can instead
          # access an environment variable to find the master
          # service's host. To do so, comment out the 'value: dns' line above, and
          # uncomment the line below:
          # value: env
        ports:
        - containerPort: 6379
---
# Source: CAESAR-kube-openmpi/templates/horizonalPodAutoscaler.yaml
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: caesar-openmpi-master
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: caesar-openmpi-master
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 5
---
# Source: CAESAR-kube-openmpi/templates/horizonalPodAutoscaler.yaml
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: caesar-openmpi-worker
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: caesar-openmpi-worker
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
---
# Source: CAESAR-kube-openmpi/templates/mpi-cluster.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: caesar-openmpi-worker
  labels:
    app: CAESAR-kube-openmpi
    chart: CAESAR-kube-openmpi-0.1
    release: caesar-openmpi
    heritage: Helm
    role: worker
spec:
  selector:
    matchLabels:
      app: CAESAR-kube-openmpi
      chart: CAESAR-kube-openmpi-0.1
      release: caesar-openmpi
      heritage: Helm
      role: worker
  serviceName: caesar-openmpi
  podManagementPolicy: Parallel
  replicas: 1
  template:
    metadata:
      labels:
        app: CAESAR-kube-openmpi
        chart: CAESAR-kube-openmpi-0.1
        release: caesar-openmpi
        heritage: Helm
        role: worker
    spec:
      securityContext:
        null
      volumes:
      - name: kube-openmpi-ssh-key
        secret:
          secretName: caesar-openmpi-ssh-key
          defaultMode: 256
      - name: kube-openmpi-utils
        configMap:
          name: caesar-openmpi-assets
          items:
          - key: gen_hostfile.sh
            path: gen_hostfile.sh
            mode: 365

      - name: nfs-neanias-mpi
        persistentVolumeClaim:
          claimName: nfs-neanias-mpi

      initContainers:
      containers:
      - name: mpi-worker
        image: "jordaan0/caesar-rest:version-0.0.9"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 2022
          containerPort: 8080
        volumeMounts:
        - name: kube-openmpi-ssh-key
          mountPath: /ssh-key/openmpi
        - name: kube-openmpi-utils
          mountPath: /kube-openmpi/utils

        - mountPath: /workspace
          name: nfs-neanias-mpi

        resources:
          requests:
            cpu: "0.5"
